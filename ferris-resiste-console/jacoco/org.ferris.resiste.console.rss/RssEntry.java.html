<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RssEntry.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ferris-resiste-console</a> &gt; <a href="index.source.html" class="el_package">org.ferris.resiste.console.rss</a> &gt; <span class="el_source">RssEntry.java</span></div><h1>RssEntry.java</h1><pre class="source lang-java linenums">package org.ferris.resiste.console.rss;

import java.util.Arrays;
import java.util.Date;
import java.util.LinkedList;
import java.util.List;
import java.util.StringJoiner;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.stream.Collectors;
import javax.enterprise.inject.Vetoed;

/**
 *
 * @author Michael Remijan mjremijan@yahoo.com @mjremijan
 */
@Vetoed
<span class="fc" id="L17">public class RssEntry {</span>
    
    private static String trim(String in) {
<span class="pc bpc" id="L20" title="1 of 2 branches missed.">        return (in == null) ? null : in.trim();</span>
    }
    
    public String feedId;
    
    public String getFeedId() {
<span class="nc" id="L26">        return feedId;</span>
    }

    public void setFeedId(String feedId) {
<span class="nc" id="L30">        this.feedId = trim(feedId);</span>
<span class="nc" id="L31">    }</span>
    
    public String entryId;

    public String getEntryId() {
<span class="nc" id="L36">        return entryId;</span>
    }

    public void setEntryId(String entryId) {
<span class="nc" id="L40">        this.entryId = trim(entryId);</span>
<span class="nc" id="L41">    }</span>

    public String title;

    public String getTitle() {
<span class="nc" id="L46">        return title;</span>
    }

    public void setTitle(String title) {
<span class="nc" id="L50">        this.title = trim(title);</span>
<span class="nc" id="L51">    }</span>

    public String contents;

    public String getContents() {
<span class="fc" id="L56">        return contents;</span>
    }

    public void setContents(String theContents) {
<span class="fc" id="L60">        contents </span>
<span class="fc" id="L61">            = trim(theContents);</span>
        
        // This code will look for &lt;img&gt; tags within
        // the contents of the RSS entry. The idea is
        // for this code to remove the &quot;height&quot; and
        // &quot;width&quot; attributes from the &lt;img&gt; tag so
        // that pictures display without being too
        // big.
        try 
        {
<span class="fc" id="L71">            List&lt;Img&gt; theTags</span>
                = new LinkedList&lt;&gt;();

<span class="fc" id="L74">            char [] htmlArr </span>
<span class="fc" id="L75">                = contents.toCharArray();</span>

            // Find all of the &lt;img&gt; tags and their contents
<span class="fc bfc" id="L78" title="All 2 branches covered.">            for (int begin=0; begin&lt;htmlArr.length; begin++) {</span>
<span class="fc bfc" id="L79" title="All 2 branches covered.">                if (htmlArr[begin] == '&lt;') {</span>
<span class="fc" id="L80">                    String tag = contents.substring(begin, Math.min(begin+4, contents.length())).toLowerCase();</span>
<span class="fc bfc" id="L81" title="All 2 branches covered.">                    if (tag.equalsIgnoreCase(&quot;&lt;img&quot;)) {</span>
<span class="fc" id="L82">                        int end = contents.indexOf('&gt;', begin);</span>
<span class="fc bfc" id="L83" title="All 2 branches covered.">                        if (end != -1) {</span>
<span class="fc" id="L84">                            String imgstr </span>
<span class="fc" id="L85">                                = contents.substring(begin, Math.min(end + 1, contents.length()));</span>
<span class="pc bpc" id="L86" title="1 of 2 branches missed.">                            if (imgstr != null) {</span>
<span class="fc" id="L87">                                int h = imgstr.toLowerCase().indexOf(&quot;height&quot;);</span>
<span class="fc" id="L88">                                int w = imgstr.toLowerCase().indexOf(&quot;width&quot;);</span>
<span class="fc bfc" id="L89" title="All 2 branches covered.">                                if (h != -1) {</span>
<span class="fc" id="L90">                                    h = begin + h;</span>
                                }
<span class="fc bfc" id="L92" title="All 2 branches covered.">                                if (w != -1) {</span>
<span class="fc" id="L93">                                    w = begin + w;</span>
                                }
<span class="fc bfc" id="L95" title="All 4 branches covered.">                                if (h != -1 || w != -1) {</span>
<span class="fc" id="L96">                                    theTags.add(</span>
<span class="fc" id="L97">                                        new Img(begin, end, w, h, imgstr)</span>
                                    );
                                }
                            }
                        }
                    }
                }
            }
            
            // Sort the index values for the &quot;height&quot;
            // and &quot;width&quot; atrributes from lowest to
            // highests, removing &quot;-1&quot; values meaning
            // the attribute was not found
<span class="fc" id="L110">            List&lt;Integer&gt; sortedIndexes </span>
<span class="fc" id="L111">            = theTags.stream()</span>
<span class="fc" id="L112">                .map(t -&gt; Arrays.asList(t.heightBegin, t.widthBegin))</span>
<span class="fc" id="L113">                .flatMap(list -&gt; list.stream())</span>
<span class="fc bfc" id="L114" title="All 2 branches covered.">                .filter(i -&gt; i != -1)</span>
<span class="fc" id="L115">                .sorted()</span>
<span class="fc" id="L116">                .collect(Collectors.toList())</span>
            ;
            
            // Recreate the contents of the RSS entry, but
            // remove the &quot;height&quot; and &quot;width&quot; attributes...
            // or making them ineffective to HTML rendering
<span class="fc" id="L122">            AtomicInteger index = new AtomicInteger(0);</span>
<span class="fc" id="L123">            List&lt;String&gt; split = sortedIndexes.stream()</span>
<span class="fc" id="L124">                .map(end -&gt; </span>
<span class="fc" id="L125">                        contents.substring(index.getAndSet(end), Math.min(end, contents.length()))</span>
                        + &quot;resiste&quot;
<span class="fc" id="L127">                ).collect(Collectors.toList())</span>
            ;
<span class="fc" id="L129">            split.add(contents.substring(index.get()));</span>
            
            // Save final contents
<span class="fc" id="L132">            contents = String.join(&quot;&quot;, split);</span>
<span class="nc" id="L133">        } catch (Exception e) {</span>
<span class="nc" id="L134">            throw new RuntimeException(</span>
<span class="nc" id="L135">                String.format(&quot;An problem occured trying to process the &lt;img&gt; &quot;</span>
                    + &quot;tags of the RssEntry content. Original HTML: \&quot;%s\&quot;&quot;,theContents)
              , e
            );
<span class="fc" id="L139">        }</span>
        
        // This code will add more styling to the &lt;img&gt;, hopefully to help Yahoo!
<span class="fc" id="L142">        this.contents</span>
<span class="fc" id="L143">            = contents.replaceAll(&quot;&lt;([iI])([mM])([gG])&quot;, &quot;&lt;$1$2$3 style=\&quot;max-width: 99%;\&quot;&quot;);</span>
<span class="fc" id="L144">    }</span>

    class Img {
        Integer tagBegin;
        Integer tagEnd;
        Integer widthBegin;
        Integer heightBegin;
        String contents;

<span class="fc" id="L153">        public Img(Integer tagBegin, Integer tagEnd, Integer widthBegin, Integer heightBegin, String contents) {</span>
<span class="fc" id="L154">            this.tagBegin = tagBegin;</span>
<span class="fc" id="L155">            this.tagEnd = tagEnd;</span>
<span class="fc" id="L156">            this.widthBegin = widthBegin;</span>
<span class="fc" id="L157">            this.heightBegin = heightBegin;</span>
<span class="fc" id="L158">            this.contents = contents;</span>
<span class="fc" id="L159">        }</span>

        @Override
        public String toString() {
<span class="nc" id="L163">            StringJoiner sj = new StringJoiner(&quot;, &quot;, &quot;[Img &quot;, &quot;]&quot;);</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">            sj.add(String.format(&quot;tagBegin:%s&quot;, (tagBegin == null) ? &quot;null&quot; : tagBegin));</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">            sj.add(String.format(&quot;tagEnd:%s&quot;, (tagEnd == null) ? &quot;null&quot; : tagEnd));</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">            sj.add(String.format(&quot;widthBegin:%s&quot;, (widthBegin == null) ? &quot;null&quot; : widthBegin));</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">            sj.add(String.format(&quot;heightBegin:%s&quot;, (heightBegin == null) ? &quot;null&quot; : heightBegin));</span>
<span class="nc" id="L168">            sj.add(String.format(&quot;contents:\&quot;%s\&quot;&quot;, contents));</span>
<span class="nc" id="L169">            return sj.toString();</span>
        }
    }
    
    public String author;

    public String getAuthor() {
<span class="nc" id="L176">        return author;</span>
    }

    public void setAuthor(String author) {
<span class="nc" id="L180">        this.author = trim(author);</span>
<span class="nc" id="L181">    }</span>

    public String link;

    public String getLink() {
<span class="nc" id="L186">        return link;</span>
    }

    public void setLink(String link) {
<span class="nc" id="L190">        this.link = trim(link);</span>
<span class="nc" id="L191">    }</span>

    public Date publishedDate;

    public Date getPublishedDate() {
<span class="nc" id="L196">        return publishedDate;</span>
    }

    public void setPublishedDate(Date publishedDate) {
<span class="nc" id="L200">        this.publishedDate = publishedDate;</span>
<span class="nc" id="L201">    }</span>

<span class="fc" id="L203">    protected List&lt;RssImage&gt; images = new LinkedList&lt;&gt;();</span>

    public List&lt;RssImage&gt; getImages() {
<span class="nc" id="L206">        return images;</span>
    }

    public void addImage(RssImage image) {
<span class="nc" id="L210">        images.add(image);</span>
<span class="nc" id="L211">    }</span>

<span class="fc" id="L213">    protected List&lt;RssMediaFile&gt; mediaFiles = new LinkedList&lt;&gt;();</span>

    public List&lt;RssMediaFile&gt; getMediaFiles() {
<span class="nc" id="L216">        return mediaFiles;</span>
    }

    public void addMediaFile(RssMediaFile mediaFile) {
<span class="nc" id="L220">        mediaFiles.add(mediaFile);</span>
<span class="nc" id="L221">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>